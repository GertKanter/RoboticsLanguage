# The Robotics Language compiler philosophy

The `rol` compiler implements a generic engine that works by processing two types of information, **code** and **parameters**, thought three steps: **input**, **transformations**, and **output**.



![](../../Assets/compiler-flow.png)

In this document we will use the words **inputs** or **parser** interchangeably, meaning the process of transforming text written in a particular language to an [abstract syntax tree](https://en.wikipedia.org/wiki/Abstract_syntax_tree) implemented in [xml](https://en.wikipedia.org/wiki/XML), i.e. the internal representation of the source code.

The words **outputs** and **code generation** mean the process of transforming the abstract syntax tree into text documents, such as, c++ code, HTML pages, etc.

The word **code** refers to the abstract syntax tree implemented in **xml**. The xml structure was chosen for its ability to store attributes on each tag. Attributes can be used by each module to store information for a particular element of the abstract syntax tree, acting as _an annotation_ that can be used for decision making or code generation.

The word **parameters** refer to generic information, independent of the code, used in all the processing steps of the compiler.

The words **plug-in** or **modules** refer to processing blocks that operate on text (for input or output), code, or the parameters. The `rol` compiler is designed to be modular, composed of modules that are sequenced to process from inputs to outputs.


## The parameters

Parameters are any piece of information that may be relevant for the parsing, transformation, and code generation parts of the compiler.
Parameters are represented internally by a python dictionary.

All parameters can be assigned to command line flags that are loaded when the compiler is called. Parameters can also be loaded via YAML files.

Parameters can be printed in the terminal using the flag `--debug-parameters`:

```shell
rol helloworld.rol --debug-parameters
```

### Viewing parameters in the command line

The previous command will probably show too much information. To print only a subset of the parameters the flag `--debug-parameters-path 'path'` can be used. For example, to see only the `globals` section, one can type:

```shell
rol helloworld.rol --debug-parameters-path 'globals'
```

which returns:

```python
{'compile': False,
 'compilerLanguage': 'en',
 'debug': False,
 'deploy': '/Users/glopes/deploy/',
 'language': 'en',
 'launch': False,
 'output': 'RosCpp',
 'removeCache': False,
 'verbose': 'none'}
```

If you type `rol -h` you will be show the full help for the compiler. The section on `globals` appears as (for more information on creating custom messages for the command line see the section on [Command line options](#command-line-options) ):

```
globals:
  -c, --compile         Compiles the output of all modules
  --compiler-language STR
                        Spoken language used by the compiler
  -d, --debug           Turn on debug features for all modules
  -p STR, --deploy-path STR
                        The path where the generated code is saved
  --language STR        Spoken language used for the robotics language file
  -l, --launch          Launches the output generated by all modules
  -o [STR [STR ...]], --output [STR [STR ...]]
                        Outputs
  --remove-cache        Deletes the compiler cache
  -v STR, --verbose STR
                        Shows verbose information for the compiler and its modules
```



Note that the flag `--debug-parameters-path` uses the [dpath](https://github.com/akesterson/dpath-python) library. Please read the _dpath_ documentation for the available search options. For example, to get all the values for the key `name` in the `Information` domain one can write:

```shell
 rol helloworld.rol --debug-parameters-path 'Information/*/name'
 ```

 ### Compiler steps


The compiler follows a number of steps, represented by each individual plug-in (see figure above). You can view these steps by using the `-v` or `--verbose` flag:

 ```shell
 rol helloworld.rol -v debug
 ```

 As the compiler progresses the parameters might be updated by each plug-in. You can use the flag `--debug-step` to show the state of the parameters for a particular step:

 ```shell
 rol helloworld.rol --debug-parameters-path 'Outputs' --debug-step 7
 ```

If the flag `--debug-step` is not specified, then by default the step is 1.

If you are developing a new plug-in it may happen that the full process from parsing to code generation will not work. You can interrupt the compiler at a particular step by using the flag `--debug-stop` in combination with `--debug-step`:

 ```shell
 rol helloworld.rol --debug-parameters-path 'Outputs' --debug-step 2 --debug-stop
 ```

### Using and loading extra parameters


Parameters can also be loaded using [YAML](https://en.wikipedia.org/wiki/YAML) files

```shell
rol helloworld.rol parameters.yaml
```

Many parameters can be loaded at once. Each dictionary extracted is merged with the built in parameters. Parameters may be overwritten in this process.

```shell
rol helloworld.rol parameters1.yaml parameters2.yaml parameters3.yaml
```

In addition, the `rol` compiler will look and load automatically for the files `~/.rol/parameters.yaml` and `rol.parmameters.yaml` residing in the same folder as the `.rol` file. The order of loading is the following:

order | parameters
--|--
1 | Defaults from `rol` and from all modules (can be cached)
2 | global file `~/.rol/parameters.yaml` loaded automatically
3 | local file `rol.parameters.yaml` residing in the same folder as `.rol`, loaded automatically
4 | list of yaml files passed as arguments
5 | command line parameters specified by flags

For example the `~/.rol/parameters.yaml` can contain information about your company and yourself, so that it is inserted into the code generated automatically:

```yaml
Information:
  user:
    name: Gabriel Lopes
    email: g.lopes@robotcaresystems.com
    web: http://www.dcsc.tudelft.nl/~glopes
  company:
    name: Robot Care Systems B.V.
    address: Taco Scheltemastraat 5
    zipcode: 2509 JJ
    city: The Hague
    country: Netherlands
    email: info@robotcaresystems.com
    web: http://www.robotcaresystems.com
    telephone: +31 88 111 00 90
```

In the local `rol.parameters.yaml` you can include information about the license and copyright for that particular node:

```yaml
Information:
  software:
    name: SuperRobot
    version: 1.0.0
    description: The supervisory control engine for the robot
    maintainer:
      name: John
      email: john@some_company.com
    author:
      name: Gabriel Lopes
      email: g.lopes@robotcaresystems.com
    url: http://www.robotcaresystems.com
    license: Apache 2.0
    copyright: Robot Care Systems B.V., 2015-2018
    year: 2018
```

The c++ headers of the code generated using the RosCpp module read:

```c++
/*
 * Node name: hello world
 *
 * Generated on: 12 April, 2018
 *       Author: Gabriel Lopes
 *      Licence: Apache 2.0
 *    Copyright: Robot Care Systems B.V., 2015-2018
 *
 *    THIS FILE WAS AUTOMATICALLY GENERATED USING THE ROBOTICS LANGUAGE
 *
 */
```

The `package.xml` file reads:

```xml
<?xml version="1.0"?>
<package>
  <name>hello_world</name>
  <version>1.0.0</version>
  <description>The supervisory control engine for the robot</description>
  <maintainer email="john@some_company.com">John</maintainer>
  <license>Apache 2.0</license>
  <url type="website">http://www.robotcaresystems.com</url>
  <author email="g.lopes@robotcaresystems.com">Gabriel Lopes</author>

  <buildtool_depend>catkin</buildtool_depend>

  <build_depend>roscpp</build_depend>
  <build_depend>std_msgs</build_depend>

  <run_depend>roscpp</run_depend>
  <run_depend>std_msgs</run_depend>

</package>
```

### Parameters structure


The parameters dictionary is organised according to the following list:

- `globals` These are the main generic parameters for the compiler. These include elements such as compiler language, list of outputs, verbosity, debugging, etc. The globals are defined in the file  [`RoboticsLanguage/Base/Parameters.py`](../../RoboticsLanguage/Base/Parameters.py).

- `debug` Options for printing code and parameters, stoping compiler, etc. Definition in file [`RoboticsLanguage/Base/Parameters.py`](../../RoboticsLanguage/Base/Parameters.py).

- `Information` Personal and company information that is embedded in the code generated. These parameters are usually stored in the files `~/.rol/parameters.yaml` and local `rol.parameters.yaml`. See [`RoboticsLanguage/Base/Parameters.py`](../../RoboticsLanguage/Base/Parameters.py) for defaults.

- `Inputs` 

- `Transformers`

- `Outputs`

- `manifesto`

- `language`

- `messages`







## The code
Code is represented internally by an XML object.
