<!DOCTYPE html>
<!--
 * Node name: {{parameters['node']['name']}}
 *
 * Generated on: {{"%d %B, %Y"|todaysDate}}
 *       Author: {{parameters['Information']['user']['name']}}
 *      Licence: {{parameters['Information']['software']['license']}}
 *    Copyright: {{parameters['Information']['software']['copyright']}}
 *
 *    THIS FILE WAS AUTOMATICALLY GENERATED USING THE ROBOTICS LANGUAGE
 -->
<html>

<head>
  <meta charset="utf-8" />

  <!-- @NOTE  all of the libraries are being loaded from online repositories. This means the
              device using this example needs to be online. The libraries can be used offline
              by passing the path to the local copy of the libraries.
  -->

  <!-- Ros bridge -->
  <script type="text/javascript" src="https://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>

  <!-- semantic UI -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.css"/>

  <!-- dygraphs -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.js"></script>
  <link rel="stylesheet" type="text/css" src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.css" />


  {% if parameters['Inputs']['FiniteStateMachine']|length > 0 %}
  <!-- VisJS for easy diagrams -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" />
  {% endif %}

  <!-- some extra styling to balance the page -->
  <style type="text/css">
    #mynetwork {
      width: 600px;
      height: 400px;
      border: 1px solid lightgray;
    }
  </style>

  <!-- THIS IS THE JAVASCRIPT PART -->

  <!-- ros interaction  -->
  <script type="text/javascript" type="text/javascript">

    // Connecting to ROS
    // -----------------
    var ros = new ROSLIB.Ros({
      url: 'ws://localhost:9090' // this is the standard rosbridge port
    });

    ros.on('connection', function() {
      console.log('Connected to websocket server.');
    });

    // Displays a message in case conection failed
    ros.on('error', function(error) {
      $('#ros_bridge').transition('show');
      $('#ros_bridge_header').html('Error connecting to websocket server: ' + error);
      console.log('Error connecting to websocket server: ', error);
    });

    // Displays a message when connection ends
    ros.on('close', function() {
      $('#ros_bridge').transition('show');
      $('#ros_bridge_header').html('Connection to websocket server closed!');
      console.log('Connection to websocket server closed.');
    });


    // // Subscribing and publishing to a topics
    // // ----------------------
    //
    // // a subscriber
    // var subscriber_echo = new ROSLIB.Topic({
    //   ros: ros,
    //   name: '/webguis/example/response',
    //   messageType: 'std_msgs/String',
    //   // latch: true
    // });
    //
    // // a publisher
    // var publisher_echo = new ROSLIB.Topic({
    //   ros: ros,
    //   name: '/webguis/example/question',
    //   messageType: 'std_msgs/String',
    //   // latch: true
    // });



    // // Callback functions for subscribers
    // // ------------------
    // subscriber_echo.subscribe(function(message) {
    //
    //   // fill in the respose field
    //   $('#response').html(message.data);
    //
    // });
    //
    // // Helping functions for publishing
    // // ------------------
    // function publishMessage()
    // {
    //   // read the value of the input field
    //   text = $('#echo').val()
    //
    //   // create a string ROS message
    //   var str = new ROSLIB.Message({
    //     data : text
    //   });
    //
    //   // publish
    //   publisher_echo.publish(str)
    // }


    // helping functions
    function checkboxRowShowHide(name)
    {
      if($('#checkbox_' + name).is(":checked"))
      {
          $('#row_' + name).show();
      }
      else
      {
        $('#row_' + name).hide();
      }
    }


$(document).ready(function () {

  $("#div_voltages").css({"display":"block"});
    data_voltages = [[0,0],[1,2],[2,3]]
    var g_voltages = new Dygraph(document.getElementById("div_voltages"), data_voltages, {
    //      legend: 'always',
    //      title: 'Voltages',
    //      ylabel: 'Voltage (V)',
    //      xlabel: 'Time',
          drawPoints: false,
          showRoller: false,
          //  valueRange: [0, 30],
          labels: ['Time', 'Voltage']
        });

        var x = new Date();

        data_voltages.push([x, 0]);
        g_voltages.updateOptions({
          'file': data_voltages
        });
})

  </script>
</head>

<!-- THIS IS THE HTML PART -->

<body>
  <div class="ui container">
  <h1> {{parameters['node']['name']}} </h1>

  <!-- This part is hidden from view unless there is an error connecting to rosbridge.
      Please do not change this part -->
  <div class="ui icon error big message hidden" id="ros_bridge">
    <i class="warning circle icon"></i>
    <div class="content" >
      <div class="header" id="ros_bridge_header">

      </div>
      <p id="ros_bridge_text">
      Please make sure that you run "<code>roslaunch rosbridge_server rosbridge_websocket.launch</code>" in the terminal. Then refresh this page.</p>
    </div>
  </div>

  <!-- Here is the content of the page -->

  {% if parameters|dpath('/Transformers/ROS/topicDefinitions')|length > 0 %}
  <h1>List of ROS topics</h1>

  <table class="ui celled table">
    <thead>
      <tr>
        <th></th>
        <th>Name</th>
        <th>Type</th>
        <th>Flow</th>
      </tr>
    </thead>
    <tbody>
  {% for topic in parameters|dpath('/Transformers/ROS/topicDefinitions') %}
      <tr>
        <td>
          <div class="ui checkbox">
            <input type="checkbox" id="checkbox_{{topic['topic_name']|underscore}}"  onclick="checkboxRowShowHide('{{topic['topic_name']|underscore}}');">
            <label></label>
          </div>
        </td>
        <td>{{topic['topic_name']}}</td>
        <td>{{topic['ros_type']}}</td>
        <td>{{topic['flow']}}</td>
      </tr>
      <tr hidden id="row_{{topic['topic_name']|underscore}}">
        <td colspan="4">

          {% if topic['ros_type'] == 'std_msgs::String' %}

          <div class="ui tiny message" id="string_{{topic['topic_name']|underscore}}">
            <p>line 1</p>
            <p>line 2</p>
        </div>

          <div class="ui action input">
            <input type="text" placeholder="publish">
            <button class="ui button">publish</button>
          </div>

          {% endif %}

          {% if 'std_msgs::Float' in topic['ros_type'] or 'std_msgs::Integer' in topic['ros_type'] %}

          <div class="ui statistic">
          <div class="value">
            5,550
          </div>
        </div>

        <div id="div_voltages"></div>

          <div class="ui action input">
            <input type="text" placeholder="publish">
            <button class="ui button">publish</button>
          </div>

          {% endif %}



        </td>
      </tr>
  {% endfor %}
    </tbody>
  </table>

  {% endif %}


{% if parameters['Inputs']['FiniteStateMachine']|length > 0 %}


{% set list_of_states = parameters|dpath('Inputs/FiniteStateMachine/parameters/list_of_states') %}
{% set transition_labels = parameters|dpath('Inputs/FiniteStateMachine/parameters/transition_labels') %}
{% set transition_begins = parameters|dpath('Inputs/FiniteStateMachine/parameters/transition_begins') %}
{% set transition_ends = parameters|dpath('Inputs/FiniteStateMachine/parameters/transition_ends') %}
{% set init = parameters|dpath('Inputs/FiniteStateMachine/parameters/init') %}
{% set num_of_transitions = parameters|dpath('Inputs/FiniteStateMachine/parameters/num_of_transitions') %}
{% set num_of_states = parameters|dpath('Inputs/FiniteStateMachine/parameters/num_of_states') %}

  <h1>Finite State Machine</h1>

  <div id="mynetwork"></div>
  <div class="ui grid">
    <div class="six column row">
      {% for state in list_of_states %}
        <div class="column"><button class="fluid ui mini toggle button" id="{{state}}" onclick="highlight('{{state}}') ">Highlight {{state}}</button></div>
      {% endfor %}
    </div>
  </div>


  <script type="text/javascript">
    // create an array with nodes
    var id = 0;
    var nodes = new vis.DataSet([
    ]);

    // create an array with edges
    var edges = new vis.DataSet([
    ]);

    // create a network
    var container = document.getElementById('mynetwork');

    // provide the data in the vis format
    var data = {
        nodes: nodes,
        edges: edges
    };
    var options = {
      edges:{
        arrows: 'to',
        color:{
            highlight : 'green',
                    },
        font: '12px arial #ff0000',
        scaling:{
          label: false,
        },
        shadow: true,
        smooth: true,
      },
      layout:{randomSeed:1},
      nodes:{
        color: {
          highlight: {
            background: '#00ff00'
            },
        },
      },
    };

    function addState (idNum, labelName)
    {
      nodes.add([{id: idNum, label: labelName}]);
    }

    function addTransition (lbl, src, dst)
    {
      edges.add([{from: src, to: dst, label: lbl ,font: {align: 'middle'}}]);
    }
    function highlight (id)
    {
      network.selectNodes([id], true);
    }

    var iter = 1;
    {% for state in list_of_states %}
      addState ("{{state}}", "{{state}}");
    {% endfor %}

    {% for elem in range(num_of_transitions) %}
        addTransition ("{{transition_labels[elem]}}", "{{transition_begins[elem]}}","{{transition_ends[elem]}}")
    {% endfor %}

    console.log(data);

    var network = new vis.Network(container, data, options);
    //Set initial state
    highlight("{{init[0]}}")


  </script>

{% endif %}



</body>

</html>
